afpc$loadings[]
# --
## limpando o workspace
rm(list = ls())
pacotes <- c("corrplot",   # matrizes de correlação
"ggplot2",    # gráficos diversos
"ggspatial",  # mapas e shapefiles
"ggsn",       # mapas e shapefiles
"raster",     # mapas e shapefiles
"rgdal",      # mapas e shapefiles
"sf",         # mapas e shapefiles
"sp",         # mapas e shapefiles
"tidyverse",  # manipulação de bases de dados
"kableExtra",
"RcmdrMisc")  # Teste KMO
if(sum(as.numeric(!pacotes %in% installed.packages())) != 0){
instalador <- pacotes[!pacotes %in% installed.packages()]
for(i in 1:length(instalador)) {
install.packages(instalador, dependencies = T)
break()}
sapply(pacotes, require, character = T)
} else {
sapply(pacotes, require, character = T)
}
## diretório de trabalho
setwd("C:/Users/Renato/OneDrive/github/_tcc/1_pca/estudo_composicoes")
#--
## carregando funções auxiliares
source("_src/src.R")
#--
## carregando dados: GeoSES Belo Horizonte (intra-municipal)
## - indicadores do censo por ÁREA DE PONDERAÇÃO
## - os dados são carregados no objeto "dta"
dta = read.csv("_dta/geoSES_BH_IM.csv")
# --
# gerando IDs
# - os IDs são os 2 últimos dígitos das APs
dta$ID = dta$enumeration_area %% 100
dta$ID
# rearranjando colunas
dta = dta %>% relocate(ID, .before = UF)
# --
## carregando shapefile de BH
# - necessário para produzir os mapas
merge.shp = raster::shapefile(
x = paste0('_out/shapefiles/belo_horizonte_AP.shp'))
# convertendo para sf
sf.obj = st_as_sf(merge.shp)
#  --
# variáveis finais
lab = c('P_SEM_INST',  # Education
'P_ENSSUP',    # Education
'P_ATE5',      # Mobility
'P_MAISDE2',   # Mobility
'M_DENSMORA',  # Poverty
'P_POBREZA',   # Poverty
'M_RENDDOM',   # Income
'P_IDOSO10SM', # Wealth
'P_ALVSREV',   # Material deprivation
'P_TUDOADEQ')  # Material deprivation
# --
## matriz de observações
X = dta[, lab]
# --
# matriz de observações padronizadas
Z = scale(X)
# --
## PCA
afpc = prcomp(Z)
# como ver Standard deviation, Proportion of Variance e
# Cumulative Proportion com esta lib?
summary(afpc)
# --
# O objeto afpc possui os seguintes componentes:
afpc$sdev
afpc$rotation
afpc$center
# --
# Visualizando os pesos que cada variável tem em cada componente principal
# obtido pela PCA
data.frame(afpc$rotation) %>%
mutate(var = names(nf[, lab])) %>%
melt(id.vars = "var") %>%
mutate(var = factor(var)) %>%
ggplot(aes(x = var, y = value, fill = var)) +
geom_bar(stat = "identity", color = "black") +
facet_wrap(~variable) +
labs(x = NULL, y = NULL, fill = "Legenda:") +
scale_fill_viridis_d() +
theme_bw()
pacotes <- c("corrplot",   # matrizes de correlação
"ggplot2",    # gráficos diversos
"ggspatial",  # mapas e shapefiles
"ggsn",       # mapas e shapefiles
"raster",     # mapas e shapefiles
"rgdal",      # mapas e shapefiles
"sf",         # mapas e shapefiles
"sp",         # mapas e shapefiles
"tidyverse",  # manipulação de bases de dados
"kableExtra",
"RcmdrMisc",  # Teste KMO
"dplyr")
if(sum(as.numeric(!pacotes %in% installed.packages())) != 0){
instalador <- pacotes[!pacotes %in% installed.packages()]
for(i in 1:length(instalador)) {
install.packages(instalador, dependencies = T)
break()}
sapply(pacotes, require, character = T)
} else {
sapply(pacotes, require, character = T)
}
# --
# Visualizando os pesos que cada variável tem em cada componente principal
# obtido pela PCA
data.frame(afpc$rotation) %>%
mutate(var = names(nf[, lab])) %>%
melt(id.vars = "var") %>%
mutate(var = factor(var)) %>%
ggplot(aes(x = var, y = value, fill = var)) +
geom_bar(stat = "identity", color = "black") +
facet_wrap(~variable) +
labs(x = NULL, y = NULL, fill = "Legenda:") +
scale_fill_viridis_d() +
theme_bw()
# --
# Visualizando os pesos que cada variável tem em cada componente principal
# obtido pela PCA
data.frame(afpc$rotation) %>%
mutate(var = names(nf[, lab])) %>%
data.frame::melt(id.vars = "var") %>%
mutate(var = factor(var)) %>%
ggplot(aes(x = var, y = value, fill = var)) +
geom_bar(stat = "identity", color = "black") +
facet_wrap(~variable) +
labs(x = NULL, y = NULL, fill = "Legenda:") +
scale_fill_viridis_d() +
theme_bw()
# Scree Plot - apenas ignorar os warnings
# para escolher quantos fatores serão retidos. Mas vamos utilizar critério de kaiser
ggplotly(
fviz_eig(X = afpc,
ggtheme = theme_bw(),
barcolor = "black",
barfill = "dodgerblue4",
linecolor = "darkgoldenrod3")
)
# Scree Plot - apenas ignorar os warnings
# para escolher quantos fatores serão retidos. Mas vamos utilizar critério de kaiser
ggplotly(
fviz_eig(X = afpc,
ggtheme = theme_bw(),
barcolor = "black",
barfill = "dodgerblue4",
linecolor = "darkgoldenrod3")
)
#--
# non-conformable arguments
# Extraindo as Cargas Fatoriais
k <- sum((afpc$sdev ^ 2) > 1) #número de variáveis presentes na base de dados
cargas_fatoriais <- afpc$rotation[, 1:k] %*% diag(afpc$sdev[1:k])
# Visualizando as cargas fatoriais
data.frame(cargas_fatoriais) %>%
rename(F1 = X1,
F2 = X2) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
# Visualizando as Comunalidades
data.frame(rowSums(cargas_fatoriais ^ 2)) %>%
rename(comunalidades = 1) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
data.frame(cargas_fatoriais) %>%
rename(F1 = X1,
F2 = X2) %>%
mutate(Comunalidades = rowSums(cargas_fatoriais ^ 2)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
df <- data.frame(Name, Age)
df <- data.frame()
View(df)
df <- data.frame(cargas_fatoriais) %>%
rename(F1 = X1,
F2 = X2) %>%
mutate(Comunalidades = rowSums(cargas_fatoriais ^ 2)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
df <- data.frame(cargas_fatoriais) %>%
rename(F1 = X1,
F2 = X2) %>%
mutate(Comunalidades = rowSums(cargas_fatoriais ^ 2)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
View(dta)
View(merge.shp)
View(sf.obj)
View(X)
View(Z)
data.frame(cargas_fatoriais)
df <- data.frame(cargas_fatoriais)
View(df)
Comunalidades = rowSums(cargas_fatoriais ^ 2)
mutate(Comunalidades = rowSums(cargas_fatoriais ^ 2))
rename(F1 = X1,
F2 = X2)
mutate(Comunalidades = rowSums(cargas_fatoriais ^ 2))
Comunalidades = rowSums(cargas_fatoriais ^ 2)
df['Comunalidade'] = rowSums(cargas_fatoriais ^ 2)
df <- data.frame(cargas_fatoriais)
pacotes <- c("corrplot",   # matrizes de correlação
"ggplot2",    # gráficos diversos
"ggspatial",  # mapas e shapefiles
"ggsn",       # mapas e shapefiles
"raster",     # mapas e shapefiles
"rgdal",      # mapas e shapefiles
"sf",         # mapas e shapefiles
"sp",         # mapas e shapefiles
"tidyverse",  # manipulação de bases de dados
"kableExtra",
"RcmdrMisc",  # Teste KMO
"dplyr",
"writexl")    # salvar em excel
if(sum(as.numeric(!pacotes %in% installed.packages())) != 0){
instalador <- pacotes[!pacotes %in% installed.packages()]
for(i in 1:length(instalador)) {
install.packages(instalador, dependencies = T)
break()}
sapply(pacotes, require, character = T)
} else {
sapply(pacotes, require, character = T)
}
write_xlsx(df,"\cargas_fatoriais_comunalidades.xlsx")
write_xlsx(df,"cargas_fatoriais_comunalidades.xlsx")
write_xlsx(df,"_out/output/cargas_fatoriais_comunalidades.xlsx")
# Plotagem das Cargas Fatoriais
data.frame(cargas_fatoriais) %>%
ggplot(aes(x = X1, y = X2)) +
geom_point(color = "dodgerblue4") +
geom_hline(yintercept = 0, color = "darkgoldenrod3", linetype = "dashed") +
geom_vline(xintercept = 0, color = "darkgoldenrod3", linetype = "dashed") +
geom_text_repel(label = row.names(cargas_fatoriais)) +
labs(x = paste("F1", paste0("(",
round(summary(afpc)$importance[2,1] * 100,
digits = 2),
"%)")),
y = paste("F2", paste0("(",
round(summary(afpc)$importance[2,2] * 100,
digits = 2),
"%)"))) +
theme_bw()
# Plotagem das Cargas Fatoriais
data.frame(cargas_fatoriais) %>%
ggplot(aes(x = X1, y = X2)) +
geom_point(color = "dodgerblue4") +
geom_hline(yintercept = 0, color = "darkgoldenrod3", linetype = "dashed") +
geom_vline(xintercept = 0, color = "darkgoldenrod3", linetype = "dashed") +
geom_text_repel(label = row.names(cargas_fatoriais)) +
labs(x = paste("F1", paste0("(",
round(summary(afpc)$importance[2,1] * 100,
digits = 2),
"%)")),
y = paste("F2", paste0("(",
round(summary(afpc)$importance[2,2] * 100,
digits = 2),
"%)"))) +
theme_bw()
# --
# Relatório das cargas fatoriais e das comunalidades
data.frame(cargas_fatoriais) %>%
rename(F1 = X1,
F2 = X2) %>%
mutate(Comunalidades = rowSums(cargas_fatoriais ^ 2)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
# Plotagem das Cargas Fatoriais
data.frame(cargas_fatoriais) %>%
ggplot(aes(x = X1, y = X2)) +
geom_point(color = "dodgerblue4") +
geom_hline(yintercept = 0, color = "darkgoldenrod3", linetype = "dashed") +
geom_vline(xintercept = 0, color = "darkgoldenrod3", linetype = "dashed") +
geom_text_repel(label = row.names(cargas_fatoriais)) +
labs(x = paste("F1", paste0("(",
round(summary(afpc)$importance[2,1] * 100,
digits = 2),
"%)")),
y = paste("F2", paste0("(",
round(summary(afpc)$importance[2,2] * 100,
digits = 2),
"%)"))) +
theme_bw()
# Scores Fatoriais
scores_fatoriais <- t(afpc$rotation)/afpc$sdev
colnames(scores_fatoriais) <- colnames(nf_std)
colnames(scores_fatoriais) <- colnames(X)
scores_fatoriais
scores_fatoriais %>%
t() %>%
data.frame() %>%
rename(PC1 = 1,
PC2 = 2) %>%
select(PC1, PC2) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
scores_fatoriais
t()
data.frame()
select(PC1, PC2)
t(afpc$rotation)/afpc$sdev
afpc$rotation
colnames(X)
scores_fatoriais
colnames(X)
scores_fatoriais
t(scores_fatoriais)
t(scores_fatoriais[:2])
t(scores_fatoriais[,2])
t(scores_fatoriais[,1:k])
scores_fatoriais[,1:k]
t(scores_fatoriais)[,1:k]
rowSums(cargas_fatoriais ^ 2)
df = dft(scores_fatoriais)[,1:k]
df = t(scores_fatoriais)[,1:k]
df
t(scores_fatoriais)[,1:1]
t(scores_fatoriais)[,1:k]
t(scores_fatoriais)[,1:1]
t(scores_fatoriais)[,2:2]
t(scores_fatoriais)[,1:2]
df = t(scores_fatoriais)[,1:2]
df
write_xlsx(df,"_out/output/scores_fatoriais.xlsx")
df = t(scores_fatoriais)[,1:2]
write_xlsx(df,"_out/output/scores_fatoriais.xlsx")
df  <-  t(scores_fatoriais)[,1:2]
write_xlsx(df,"_out/output/scores_fatoriais.xlsx")
df  <-  data.frame(t(scores_fatoriais)[,1:2])
write_xlsx(df,"_out/output/scores_fatoriais.xlsx")
df
scores_fatoriais %>%
t() %>%
data.frame() %>%
rename(PC1 = 1,
PC2 = 2) %>%
select(PC1, PC2) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
scores_fatoriais
scores_fatoriais[1,]
scores_fatoriais[2,]
# Assumindo-se apenas o F1 e F2 como indicadores, calculam-se os scores
# fatorias
score_D1 <- scores_fatoriais[1,] # selecionando a primeira linha
score_D1
score_D2 <- scores_fatoriais[2,] # selecionando a segunda linha
score_D2
# Estabelecendo o ranking dos indicadores assumido
F1 <- t(apply(nf_std, 1, function(x) x * score_D1))
# Estabelecendo o ranking dos indicadores assumido
F1 <- t(apply(X, 1, function(x) x * score_D1))
F2 <- t(apply(X, 1, function(x) x * score_D2))
F1
F2
# Na construção de rankings no R, devemos efetuar a multiplicação por -1,
# visto que os scores fatoriais das observações mais fortes são, por padrão,
# presentados acompanhados do sinal de menos.
F1 <- data.frame(F1) %>%
mutate(fator1 = rowSums(.) * 1)
F1 %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
F2 <- data.frame(F2) %>%
mutate(fator2 = rowSums(.) * -1)
F2 %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
# Importando as colunas de fatores F1 e F2
X["Fator1"] <- F1$fator1
X["Fator2"] <- F2$fator2
res_ACP = X[,c('Fator1', 'Fator2')]
# Calculando a variância compartilhada
var_compartilhada <- (afpc$sdev ^ 2/sum(afpc$sdev ^ 2))
var_compartilhada
X %>%
mutate(pontuacao = Fator1 * var_compartilhada[1] +
Fator2 * var_compartilhada[2]) -> nf
# Visualizando o ranking final
X %>%
arrange(desc(pontuacao)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
X %>%
mutate(pontuacao = Fator1 * var_compartilhada[1] +
Fator2 * var_compartilhada[2]) -> nf
pontuacao
X %>%
mutate(pontuacao = Fator1 * var_compartilhada[1] +
Fator2 * var_compartilhada[2]) -> nf
pontuacao
# Visualizando o ranking final
X %>%
arrange(desc(pontuacao)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
View(X)
X %>%
mutate(pontuacao <- Fator1 * var_compartilhada[1] +
Fator2 * var_compartilhada[2]) -> nf
# Visualizando o ranking final
X %>%
arrange(desc(pontuacao)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
arrange(desc(pontuacao))
Fator1 * var_compartilhada[1] +
Fator2 * var_compartilhada[2]
mutate(pontuacao = Fator1 * var_compartilhada[1] +
Fator2 * var_compartilhada[2]) -> nf
X %>%
mutate(pontuacao = Fator1 * var_compartilhada[1] +
Fator2 * var_compartilhada[2]) -> X
# Visualizando o ranking final
X %>%
arrange(desc(pontuacao)) %>%
kable() %>%
kable_styling(bootstrap_options = "striped",
full_width = T,
font_size = 10)
write_xlsx(X,"_out/output/fatores_e_ranking_final.xlsx")
dta
# --
# gerando IDs
# - os IDs são os 2 últimos dígitos das APs
dta$ID = dta$enumeration_area %% 100
dta$ID
# rearranjando colunas
dta = dta %>% relocate(ID, .before = UF)
X
dta[,2]
dta[,1:2]
dta[,1:4]
dta[,1:5]
X$ID = dta$enumeration_area %% 100
write_xlsx(X,"_out/output/fatores_e_ranking_final.xlsx")
X
dta$ID
dta %>% relocate(ID, .before = UF)
X$ID
X
NEW = X %>% relocate(ID, .before = P_SEM_INST)
NEW
write_xlsx(NEW,"_out/output/fatores_e_ranking_final.xlsx")
# --
# salvando os resultados em um arquivo de texto
sink(file = '_out/output/pca_final.txt')
print(summary(afpc))
sink()
sink(file = '_out/output/loadings_final.txt')
print(afpc$loadings[])
sink()
afpc$loadings[]
afpc$rotation
# --
# O objeto afpc possui os seguintes componentes:
afpc$sdev
sink(file = '_out/output/rotation_final.txt')
print(afpc$rotation)
sink()
# --
# Teste de Bartlett de Esfericidade
Bartlett.sphericity.test <- function(x)
{
method <- "Bartlett's test of sphericity"
data.name <- deparse(substitute(x))
x <- subset(x, complete.cases(x)) # Omit missing values
n <- nrow(x)
p <- ncol(x)
chisq <- (1-n+(2*p+5)/6)*log(det(cor(x)))
df <- p*(p-1)/2
p.value <- pchisq(chisq, df, lower.tail=FALSE)
names(chisq) <- "X-squared"
names(df) <- "df"
return(structure(list(statistic=chisq, parameter=df, p.value=p.value,
method=method, data.name=data.name), class="htest"))
}
# --
# Resultado do Teste de Esfericidade:
Bartlett.sphericity.test(X)
